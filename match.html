<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" type ="text/css" href="home.css">
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" src="util.js"></script>

    <!-- Below are from chat.html -->
<!--     <link rel="stylesheet" href="main.css" /> -->    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script type="text/javascript" src="util.js"></script>
    <link rel="stylesheet" type ="text/css" href="home.css">
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="main.js"></script>

    <style>

      body{
        background-color: #ffffff !important;
      }

      #decline, #checkmark, #bio, #name{
    	position: absolute !important;
    	z-index: 3 !important;
      }
      

      #name, #bio{
      	color: white !important;
      }

      #main-width{
        width: 90%;
        margin-left: auto;
        margin-right: auto;
        position: relative;
        
      }

      #main-container{
        margin-top: 120px;
        background-color: lightgrey;
        border-radius: 15px;
        padding: 30px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        height: 550px;
        position: relative;
        background-position: center; 
        background-size: cover;
        /*position: absolute;
        z-index: 2;*/
      }

      .overlay{
        background-color: black;
    		opacity: 30%;
    		position: absolute;
    		width: 100%;
    		height: 100%
    		padding: 0;
    		margin: 0;
    		top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
  		  border-radius: 15px;
  	  }

      .invisible{
        display: none;
      }

      #bio{
        font-size: 18px;
        color: rgba(42, 103, 201, 1.0);
        font-family: "raleway", sans-serif;
        position: absolute;
        width: 80% !important;
        left: 50%;
        transform: translate(-50%, -50%);
        bottom:40px;
        text-align: center;
      }

      #chat-container{
        display: none;
        color: rgba(42, 103, 201, 1.0);
        position: absolute;
        z-index: 5 !important;
        left: 50%;
        transform: translate(-50%, -50%);
        top: 50%;
        text-align: center;
        width: 100%;
        max-width: 750px;
        margin-left: auto;
        margin-right: auto;
        background-color: #fff;
        box-shadow: 0 1px 11px rgba(0, 0, 0, 0.27);
        height: calc(100% - 60px);
        max-height: 600px; 
        border-radius: 15px;
      }

      .chat-header {
        text-align: center;
        padding: 15px;
        border-bottom: 1px solid #ececec;
        background-color: #4089ff;
        border-radius: 15px 15px 0px 0px; /*TL TR BR BL*/
        font-family: "raleway", sans-serif !important;
        height: 65px;
      }

      .connecting {
        padding-top: 5px;
        text-align: center;
        color: #777;
        position: absolute;
        top: 65px;
        width: 100%;
        font-family: "raleway", sans-serif !important;
      }

      #disconnect{
        position: absolute;
        bottom: -70px;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        z-index: 1;
      }

      #messageForm{
        position: absolute;
        bottom: -30px;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        width: 90%;
        z-index: 1;

      }

      #messageForm .input-group input {
        float: left;
        width: calc(100% - 85px);
      }

      #messageForm .input-group button {
        float: left;
        width: 80px;
        height: 38px;
        margin-left: 5px;
      }

      input {
        padding-left: 10px;
        outline: none;
      }

      .form-control {
        width: 100%;
        min-height: 38px;
        font-size: 15px;
        border: 1px solid #c8c8c8;
      }

      button {
        box-shadow: none;
        border: 1px solid transparent;
        font-size: 14px;
        outline: none;
        line-height: 100%;
        white-space: nowrap;
        vertical-align: middle;
        padding: 0.6rem 1rem;
        border-radius: 2px;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        min-height: 38px;
        border-radius: 15px !important;
      }

      button.default {
        background-color: #4089ff !important;
        color: #333;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.12);
      }

      button.primary {
        background-color: #4089ff !important;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.12);
        color: #fff !important;
      }

      button.accent {
        background-color: #4089ff !important;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.12);
        color: #fff !important;
      }

      .title{
        margin-bottom: 30px;
        color: rgba(42, 103, 201, 1.0);
        font-family: "raleway", sans-serif;
      }

      #loading{
        font-size: 60px;
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        z-index: -2;
        margin:0;
        padding:0;
        width: 100px;
      }

      #noResults{
        font-size: 30px;
        color: #4089ff;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -40%);
        transform: translate(-50%, 120%);
        z-index: -2;
        margin:0;
        padding:0;
        text-align: center;
        font-family: "raleway", sans-serif;
      }

      #checkmark{
        position: absolute;
        right: 20px;
        bottom: 20px;
        width: 60px;
        cursor: pointer;
      }

      #decline{
        position: absolute;
        left: 25px;
        bottom: 20px;
        width: 45px;
        cursor: pointer;
      }

      @media (min-width: 768px){
        #main-width{
          width: 70%;
        }

        #main-container{
          width: 80%;
          padding: 40px;
        }

        body{
          background-position: 10% 40%;
        }
      }

      @media (min-width: 992px){
        #main-width{
          width: 65%;
        }

        #main-container{
          width: 25%;
        }

        body{
          
          background-position: initial;
        }
      }

    </style>

    <title>Match Now</title>
  </head>
  <body>
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-light">
      <a class="navbar-brand" href="index.html">calypso</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class = "nav-item">
            <a href ="profile.html" class="nav-link active"> Profile </a>
          </li>
          <li  id="soButton" class = "nav-item invisible">
            <a onclick="signOut()" class="nav-link active"> Profile </a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="main-width">

      <img id="loading" src="loading.gif">

      <h2 id="noResults" class="invisible">Sorry! We couldn't find a match for you at this time. We'll keeping looking though!</h2>

      <div id="main-container" class="invisible">

        <h2 id="name" class="title"></h2>

        <p id="bio"></p>


        <a id="decline"><img style="width: 100%;" onclick="decline(event, this)" src="decline.png"></a>
        <a id="checkmark"><img style="width: 100%;" onclick="connect(event, this)" src="heart.png"></a> 
        <div class="overlay"></div>
        <!-- add onclick function to make match -->
      </div>

      <div id="chat-container">

            <div class="chat-header">
                <h2 id="name">Christopher</h2> <!-- name of match -->
            </div>
            <div class="connecting">
                Connecting...
            </div>
            <ul id="messageArea">

            </ul>
            <form id="messageForm" name="messageForm">
                <div class="form-group">
                    <div class="input-group clearfix">
                        <input type="text" id="message" placeholder="Type a message..." autocomplete="off" class="form-control"/>
                        <button id="sendButton" type="submit" class="primary">Send</button>

                    </div>
                </div>
            </form>
             <button type="submit" id="disconnect" class="btn btn-danger">Disconnect</button>
        </div>

    </div>

    <script>


      let inChat = 0;

      let myDecision = 0;
      let matchDecision = 0;
      //DECISION TYPES:
      //0 -> no decision yet
      //1 -> Decline
      //2 -> Accepted
      //3 -> Leave Match

      let matchName;

      let userEmail;

      let available = 1;

      let prefix = "https://calypso-dating.herokuapp.com";

      if(getCookie("email") != ""){
        userEmail = getCookie("email");
 
          if(getCookie("active") == 0){
            nowActive(userEmail);
            setCookie("active", 1);
          }
          // findMatch(); DON"T CALL FINDMATCH() YET
      }else{
        window.location.replace("login.html");
      }

      function findMatch() {
        console.log("IN FIND MATCH");
          if (navigator.geolocation) {  
            navigator.geolocation.getCurrentPosition(showPosition);
          } else {
            alert("Geolocation is not supported by this browser.");
          }
      }

      function showPosition(position) {
        let lat = position.coords.latitude;
        let lon = position.coords.longitude;

        var URL = prefix+"/api/user/encounter?email=" + userEmail + "&lat=" + lat + "&lon=" + lon;

        console.log("AJAX GET");
        ajaxGet(URL, function(results) {
          //this is where the availability check is made
          console.log("RESULTS: "+results);
          console.log("AVAILABLE?: "+available);
          if(results == "Invalid" && available==1){
            $('#noResults').removeClass("invisible");
            findMatch();
          }
          else{
            available=0;
            var matchData = JSON.parse(results);
            matchEmail = matchData.email;
            matchName = matchData.name;

            $('#noResults').addClass("invisible");

            console.log(matchData);
            console.log(matchData.images[0]);
            console.log(matchData.images);
            $('#main-container').css("background-image", "url(" + matchData.images[0] + ")");
            $('#name').html(matchData.name);
            $('#bio').html(matchData.bio);
            $('#main-container').removeClass("invisible");
            setTimeout(rematch, 15000);
            //send message to server reporting status
          }
        });

      }
      
      function connect(username){ //1-1
        return new Promise((resolve, reject) => {
          let stompClient = Stomp.over(new SockJS(prefix+'/websocket-chat'))
          stompClient.connect({}, (frame) => resolve(stompClient))
        })
      }


      function disconnect(stompClient, username, disconnectBtn, clicked = false){
        nowInactive(userEmail, 1);
        matchEmail = "";
        matchName = "";
        available=1;
        
        stompClientSendMessage(stompClient, prefix+'/app/message', JSON.stringify({
          toWhom: matchEmail,
          fromWho: userEmail,
          message: "3",
          type: 1
        }))

        if(clicked){
          stompClientSendMessage(stompClient, prefix+'/app/unregister', userEmail);
        }
        stompClient.disconnect(); //6-1
        leaveChat();
      }

      function rematch() {
        available=1;
        $('#main-container').addClass("invisible");
        findMatch();
      }

      function stompClientSendMessage(stompClient, endpoint, message){ // 9
        stompClient.send(endpoint, {}, message)
        return stompClient
      }

      function handleMessage(stompClient, username, {fromWho, message, type}){

        // matchName = fromWho;
        if(type==0){//message is JSON DATA
          available=0;
          console.log("WE RECEIVED A MATCH");
          var matchData = JSON.parse(message);
          displayMatch(matchData);
        }
        else if(type==1){//message is a decision
          var dec = JSON.parse(message);
          matchDecision = dec.message;
          checkMatch();
        }
        else if(type==2){//message is chat message, message is already parsed.
          displayMessage(0, matchName);
        }
        else if(type==3){
          nowInactive(userEmail, 1);
          leaveChat();

        }
      }

      function clickSendButton(chatRoom, toWhom, stompClient, userEmail) {//invoke when match is made and send message button is visible
        document.getElementById("#sendButton").addEventListener('click', () => {
          
          let msg = document.getElementById("#message").value;
         
          if (msg && msg !== '') {
            stompClientSendMessage(stompClient, prefix+'/app/message', JSON.stringify({
              toWhom: toWhom,
              fromWho: userEmail,
              message: msg,
              type: 2
            }))
            
            displayMessage(0, "Me");
          } else {
            //ALERT THAT MESSAGE CANNOT BE EMPTY
          }
        }, true)
      }

      function leaveChat(){
        matchEmail = "";
        matchName = "";
        available=1;
        $('#chat-container').addClass("invisible");
        findMatch();
      }

      function displayMessage(fromMatch, name){
        var messageElement = document.createElement('li');

        messageElement.classList.add('chat-message');

        var avatarElement = document.createElement('i');
        var firstLetter = name.charAt(0);
        var avatarText = document.createTextNode(firstLetter);
        avatarElement.appendChild(avatarText);

        if(fromMatch == 1) avatarElement.style['background-color'] =  "#d3d3d3";
        else avatarElement.style['background-color'] =  "#4089ff";

        messageElement.appendChild(avatarElement);

        var usernameElement = document.createElement('span');
        var usernameText = document.createTextNode(name);
        usernameElement.appendChild(usernameText);
        messageElement.appendChild(usernameElement);

        var textElement = document.createElement('p');
        var messageText = document.createTextNode(message.content);
        textElement.appendChild(messageText);

        messageElement.appendChild(textElement);

        var messageArea = document.querySelector('#messageArea');
        messageArea.appendChild(messageElement);
        messageArea.scrollTop = messageArea.scrollHeight;

      }

      function displayMatch(matchData){
          $('#noResults').addClass("invisible");
          console.log(matchData);
          console.log(matchData.images[0]);
          console.log(matchData.images);
          matchName = matchData.name;
          matchEmail = matchData.email;
          $('#main-container').css("background-image", "url(" + matchData.images[0] + ")");
          $('#name').html(matchData.name);
          $('#bio').html(matchData.bio);
          $('#main-container').removeClass("invisible");
          setTimeout(rematch, 15000);
      }

      function decline(event, element){
        clearTimeout();

        stompClientSendMessage(stompClient, prefix+'/app/message', JSON.stringify({
          toWhom: matchEmail,
          fromWho: userEmail,
          message: "1",
          type: 1
        }))
        nowInactive(userEmail, 1);
        matchEmail = "";
        matchName = "";
        available=1;
        $('#main-container').addClass("invisible");
        findMatch();
      }

      function accept(event, element){
        stompClientSendMessage(stompClient, prefix+'/app/message', JSON.stringify({
          toWhom: matchEmail,
          fromWho: userEmail,
          message: "2",
          type: 1
        }))

        myDecision = 2;
        checkMatch();
      }

      window.onbeforeunload = function(){
          disconnect(stompClient, username, connectButton, disconnectButton, true)
      };

      function checkMatch(){
        if(matchDecision == 1){//NO MATCH
            var URL=prefix+"/api/user/update/match?user="+userEmail+"&answer=1";

            ajaxGet(URL, function(results){
              available=1;
              $('#main-container').addClass("invisible");
              findMatch();
            });
        }
        else if(myDecision == 2 && matchDecision == 2){//WE HAVE A MATCH
          var URL=prefix+"/api/user/update/match?user="+userEmail+"&answer=2";

          ajaxGet(URL, function(results){
            console.log(results);
            let JSresponse = JSON.parse(results);
            nowInactive(userEmail, 0);
            $('#main-container').addClass("invisible");
            $('#chat-container').removeClass("invisible");
          });
        }
      }

      let disconnectButton = document.getElementById("#disconnect");

      connect(userEmail).then((stompClient) => stompSubscribe(stompClient, prefix+'/user/queue/newMember', (data) => {
              console.log(data.body);//Error handle here "Could not connect to the server..."
            })).then((stompClient) => stompClientSendMessage(stompClient, prefix+'/app/register', userEmail))
            .then((stompClient) => stompSubscribe(stompClient, prefix+`/user/${userEmail}/msg`, (data) => {
                    handleMessage(stompClient, userEmail, JSON.parse(data.body))
                  })).then((stompClient) => { //5
              disconnectButton.addEventListener('click', () => disconnect(stompClient, userEmail, disconnectButton, true), true); // 6
              return stompClient;
            })

    </script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    
  </body>
</html>